<div class="admin-container">
    <main class="content">
        <div class="unity-container">
            <div class="aspect-ratio-box">
                <div id="unity-container">
                    <canvas id="unity-canvas"></canvas>
                    <div id="unity-loading-bar">
                        <div id="unity-logo"></div>
                        <div id="unity-progress-bar-empty">
                            <div id="unity-progress-bar-full"></div>
                        </div>
                    </div>
                    <div id="unity-warning"></div>
                </div>
            </div>
        </div>
    </main>
</div>

<input type="file" id="file-input" accept="image/png,image/jpeg,image/jpg" style="display: none;" />

<style>
    .unity-container {
        background: #444;
        border-radius: 10px;
        overflow: hidden;
        width: 100%;
    }
    
    .aspect-ratio-box {
        position: relative;
        width: 100%;
        padding-top: 56.25%;
        overflow: hidden;
    }
    
    #unity-container { 
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    
    #unity-canvas { 
        width: 100%;
        height: 100%;
        background: #231F20;
    }
    
    #unity-loading-bar { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); display: none }
    #unity-logo { width: 154px; height: 130px; background: #444; }
    #unity-progress-bar-empty { width: 141px; height: 18px; margin-top: 10px; background: #555; }
    #unity-progress-bar-full { width: 0%; height: 18px; margin-top: 10px; background: #4CAF50; }
    #unity-warning { position: absolute; left: 50%; top: 5%; transform: translate(-50%); background: white; padding: 10px; display: none }
    
    @media (max-width: 768px) {
        .aspect-ratio-box {
            padding-top: 75%;
        }
    }
</style>

<script>
    var unityInstance = null;
    var fileInput = document.getElementById('file-input');
    
    window.OpenFilePicker = function() {
        console.log('[WebGL] OpenFilePicker called from Unity');
        if (fileInput) {
            console.log('[WebGL] Clicking file input...');
            fileInput.click();
        } else {
            console.error('[WebGL] file-input not found!');
        }
    };
    
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (!file) {
                console.log('[WebGL] No file selected');
                return;
            }
            
            console.log('[WebGL] File selected:', file.name, file.size, 'bytes');
            
            // Kiểm tra kích thước (giới hạn 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('File quá lớn! Vui lòng chọn ảnh dưới 10MB');
                fileInput.value = '';
                return;
            }
            
            var reader = new FileReader();
            reader.onload = function(event) {
                var base64 = event.target.result;
                console.log('[WebGL] File loaded, base64 length:', base64.length);
                
                if (unityInstance) {
                    try {
                        // ✅ TẠO JSON OBJECT
                        var fileData = JSON.stringify({
                            fileName: file.name,
                            fileSize: file.size,
                            base64Data: base64
                        });
                        
                        console.log('[WebGL] Sending JSON to Unity:', file.name, file.size, 'bytes');
                        unityInstance.SendMessage('ImageEditPopup', 'OnWebGLFileSelected', fileData);
                        console.log('[WebGL] ✓ Sent successfully');
                    } catch (err) {
                        console.error('[WebGL] Error sending to Unity:', err);
                    }
                } else {
                    console.error('[WebGL] Unity instance not ready!');
                }
            };
            
            reader.onerror = function(error) {
                console.error('[WebGL] FileReader error:', error);
            };
            
            reader.readAsDataURL(file);
            fileInput.value = '';
        });
        console.log('[WebGL] ✓ file-input ready');
    } else {
        console.error('[WebGL] CRITICAL: file-input not found!');
    }
    
    var buildUrl = "/unity";
    var loaderUrl = buildUrl + "/ArtGalleryAdmin.loader.js";
    var config = {
        dataUrl: buildUrl + "/ArtGalleryAdmin.data",
        frameworkUrl: buildUrl + "/ArtGalleryAdmin.framework.js",
        codeUrl: buildUrl + "/ArtGalleryAdmin.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "Your Company",
        productName: "Gallery Admin",
        productVersion: "1.0",
    };

    var container = document.querySelector("#unity-container");
    var canvas = document.querySelector("#unity-canvas");
    var loadingBar = document.querySelector("#unity-loading-bar");
    var progressBarFull = document.querySelector("#unity-progress-bar-full");
    var warningBanner = document.querySelector("#unity-warning");

    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        container.className = "unity-mobile";
        config.devicePixelRatio = 1;
        unityShowBanner('WebGL builds are not supported on mobile devices.');
    }
    
    loadingBar.style.display = "block";

    fetch(loaderUrl)
        .then(response => {
            if (response.ok) {
                var script = document.createElement("script");
                script.src = loaderUrl;
                script.onload = () => {
                    createUnityInstance(canvas, config, (progress) => {
                        progressBarFull.style.width = 100 * progress + "%";
                    }).then((instance) => {
                        unityInstance = instance;
                        loadingBar.style.display = "none";
                        console.log('[WebGL] ✓ Unity loaded successfully');
                    }).catch((message) => {
                        warningBanner.style.display = 'block';
                        warningBanner.textContent = 'Lỗi: ' + message;
                        loadingBar.style.display = "none";
                    });
                };
                document.body.appendChild(script);
            } else {
                warningBanner.style.display = 'block';
                warningBanner.textContent = 'Không tìm thấy Unity loader';
                loadingBar.style.display = "none";
            }
        })
        .catch(error => {
            warningBanner.style.display = 'block';
            warningBanner.textContent = 'Lỗi: ' + error;
            loadingBar.style.display = "none";
        });

    function unityShowBanner(msg, type) {
        warningBanner.style.display = 'block';
        warningBanner.style.backgroundColor = type == 'error' ? 'red' : 'yellow';
        warningBanner.innerHTML = msg;
    }
</script>
